<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard | Bekalan</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
    <!-- IonIcons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="css/adminlte.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
    .content-wrapper {
        padding-top: 60px; /* Add padding to prevent content from being hidden behind the navbar */
    }
    </style>
    
</head>

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
   
    <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light fixed-top">
    <!-- Left navbar links -->
    <ul class="navbar-nav mr-auto">
        <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="bi bi-list"></i></a>
        </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href='#' id="btnLogout"><i class="bi bi-power"></i></a>
        </li>
    </ul>
    </nav>
       
        <!-- Main Sidebar Container -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <!-- Brand Logo -->
            <a href="index3.html" class="brand-link">
                <img src="img/fliec_logo.jpg" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
                <span class="brand-text font-weight-light">FLIEC</span>
            </a>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Sidebar user panel (optional) -->
                <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                    <div class="image">
                        <img src="img/jkmLogo.png" class="img-circle elevation-2" alt="User Image">
                    </div>
                    <div class="info">
                        <a href="#" class="d-block">JKM</a>
                    </div>
                </div>

                <!-- SidebarSearch Form -->

                <!-- Sidebar Menu -->
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                        <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
                        <li class="nav-item">
                            <a href="dashboard_JKM.html" class="nav-link">
                                <p>
                                    STATISTIK PPS
                                </p>
                            </a>
                        <li class="nav-item">
                            <a href="iBantuan.html" class="nav-link active">
                                <p>PERMINTAAN BEKALAN</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="staffDelegation_JKM.html" class="nav-link">
                                <p> AGIHAN TUGASAN KAKITANGAN</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="infoMangsa.html" class="nav-link">
                                <p>MAKLUMAT MANGSA</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="./addPPS.html" class="nav-link">
                                <p>PENAMBAHAN PUSAT</p>
                            </a>
                        </li>
                        <li class="nav-item">
                          <a href="ppsStatus.html" class="nav-link">
                              <p>STATUS PPS</p>
                            </a>
                      </li>
                       <li class="nav-item">
                          <a href="victimHealth_JKM.html" class="nav-link">
                              <p>REKOD KESIHATAN MANGSA</p>
                            </a>
                      </li>
                    </ul>
                </nav>
                <!-- /.sidebar-menu -->
            </div>
            <!-- /.sidebar -->
        </aside>


        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1>PERMINTAAN BEKALAN BANTUAN BANJIR</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="dashboard_JKM.html">Statistik PPS</a></li>
                                <li class="breadcrumb-item active">PERMINTAAN BEKALAN</li>
                            </ol>
                        </div>
                    </div>
                </div><!-- /.container-fluid -->
            </section>

            <!-- Main content -->
            <section class="content">
                <div class="container-fluid">

                    <!-- ===============================guna============================ -->
<body>

                     
    <div class="content">
     <div class="container mt-3">
        <div class="form-row">
            <div class="col">
                <select id="districtDropdown" class="form-control">
                    <option value="" selected disabled>PILIH MUKIM</option>
                    <option value="1">CHAAH BAHRU</option>
                    <option value="2">KAMPUNG BAHRU</option>
                    <option value="3">LINAU</option>
                    <option value="4">SRI GADING</option>
                    <option value="5">LUBOK</option>
                    <option value="6">SIMPANG KANAN</option>
                    <option value="7">SIMPANG KIRI</option>
                    <option value="8">SRI MEDAN</option>
                    <option value="9">TANJUNG SEMBRONG</option>
                    
                </select>
            </div>
            <div class="col">
                <select id="cityDropdown" class="form-control">
                    <option selected disabled>PILIH PPS</option>
                </select>
            </div>
             <div class="col">
    <select id="cardDropdown" class="form-control">
        <option value="" selected disabled>PILIH KATEGORI</option>
        <option value="test1">KEPERLUAN ASAS</option>
        <option value="test2">MAKANAN</option>
        <option value="test3">KEPERLUAN TAMBAHAN</option>
    </select>
</div>

<div class="col">
    <button id="submitBtn"class="btn" style="background-color:#1B4A7D; color: white;">Lihat Bekalan</button>
</div>
</div>




         <br>


<div class="card-container" id="test1">
    <div class="card card-primary ">
        <div class="card-header"  style="background-color: #1E3A57; color: white;">
            <h3 class="card-title">KEPERLUAN ASAS</h3>
            <div class="card-tools">
                
            </div>
        </div>
        <div class="card-body">
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <table id="example2" class="table table-bordered table-hover" style="max-height: 50px">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px">Bil</th>
                                                <th>Jenis</th>
                                                <th style="width: 150px">Status</th>
                                                <th style="width: 150px">Kuantiti</th>
                                                <th style="width: 150px">Tindakan</th>
                                                
                                            </tr>
                                        </thead>
                                        <tbody id="card1">
                                            <tr>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<div class="card-container" id="test2">
    <div class="card card-primary ">
        <div class="card-header"  style="background-color: #1E3A57; color: white;">
            <h3 class="card-title">MAKANAN</h3>
            <div class="card-tools">
                
            </div>
        </div>
        <div class="card-body">
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <table id="example2" class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px">Bil</th>
                                                <th>Jenis</th>
                                                <th style="width: 150px">Status</th>
                                                <th style="width: 150px">Kuantiti</th>
                                                <th style="width: 150px">Tindakan</th>
                                               
                                            </tr>
                                        </thead>
                                        <tbody id="card2">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<div class="card-container" id="test3">
    <div class="card card-primary ">
       <div class="card-header"  style="background-color: #1E3A57; color: white;">
            <h3 class="card-title">KEPERLUAN TAMBAHAN</h3>
            <div class="card-tools">
                
            </div>
        </div>
        <div class="card-body">
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <table id="example2" class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px">Bil</th>
                                                <th>Jenis</th>
                                                <th style="width: 150px">Status</th>
                                                <th style="width: 150px">Kuantiti</th>
                                                <th style="width: 150px">Tindakan</th>
                                               
                                            </tr>
                                        </thead>
                                        <tbody id="supplyTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
</div>
</div>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
 document.addEventListener("DOMContentLoaded", function () {
      document.getElementById('districtDropdown').selectedIndex = 0;
        document.getElementById('cityDropdown').selectedIndex = 0;
        document.getElementById('cardDropdown').selectedIndex = 0;
    // Hide all cards initially
    $('.card-container').hide();

    // Function to hide all cards
    document.getElementById('districtDropdown').addEventListener('change', function () {
        const pps_district = this.value;

        if (pps_district) {
            const formData = new FormData();
            formData.append('pps_district', pps_district);

            fetch('fetch_pps.php', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const cityDropdown = document.getElementById('cityDropdown');
                    cityDropdown.innerHTML = '<option value="" disabled selected>PILIH PPS</option>';
                    document.getElementById('cardDropdown').selectedIndex = 0;

                    data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.pps_id;
                        option.text = city.pps_name;
                        cityDropdown.add(option);
                    });
                })
                .catch(error => console.error('Error:', error));
        }
    });

    document.getElementById('cityDropdown').addEventListener('change', function () {
        document.getElementById('cardDropdown').selectedIndex = 0;
    });

    document.getElementById('submitBtn').addEventListener('click', function () {
        const districtDropdown = document.getElementById('districtDropdown');
        const cityDropdown = document.getElementById('cityDropdown');
        const cardDropdown = document.getElementById('cardDropdown');

        if (!districtDropdown.value) {
            Swal.fire({
                icon: 'error',
                title: 'Sila pilih Mukim',
                showConfirmButton: true,
                timer: 2000 // 3 seconds
            });
            return;
        }
        if (!cityDropdown.value) {
            Swal.fire({
                icon: 'error',
                title: 'Sila pilih PPS',
                showConfirmButton: true,
                timer: 2000 // 3 seconds
            });
            return;
        }
        
        if (!cardDropdown.value) {
            Swal.fire({
                icon: 'error',
                title: 'Sila pilih Kad',
                showConfirmButton: true,
                timer: 2000 // 3 seconds
            });
            return;
        }
        

        // Hide all cards
        $('.card-container').hide();

        // Get the selected card value
        const selectedCard = $('#cardDropdown').val();

        // Show the selected card
        if (selectedCard) {
            $('#' + selectedCard).show();
        }

        const pps_id = cityDropdown.value;

        const formData = new FormData();
        formData.append('pps_id', pps_id);

        fetch('fetch_supplies.php', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Check if there is any data
                if (data.length === 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Tiada data bagi PPS yang dipilih.',
                        showConfirmButton: true,
                        timer: 2000 // 3 seconds
                    });
                    $('.card-container').hide();
                    return;
                }

                // Filter data based on supply_type
                const firstCardData = data.filter(item => item.supply_type === 0);
                const secondCardData = data.filter(item => item.supply_type === 1);
                const thirdCardData = data.filter(item => item.supply_type === 2);

                // Populate first card table
                let firstCardTableBody = $('#card1');
                firstCardTableBody.empty(); // Clear previous data
                let rowNumber = 1;
                firstCardData.forEach(supply => {
                    appendRowToTable(firstCardTableBody, supply, rowNumber++);
                });

                // Populate second card table
                let secondCardTableBody = $('#card2');
                secondCardTableBody.empty(); // Clear previous data
                rowNumber = 1;
                secondCardData.forEach(supply => {
                    appendRowToTable(secondCardTableBody, supply, rowNumber++);
                });

                // Populate third card table
                let thirdCardTableBody = $('#supplyTableBody');
                thirdCardTableBody.empty(); // Clear previous data
                rowNumber = 1;
                thirdCardData.forEach(supply => {
                    appendRowToTable(thirdCardTableBody, supply, rowNumber++);
                });

                // Add event listener to save buttons in each card table
                $('.save-btn').off('click').on('click', function () {
    let row = $(this).closest('tr');
    let supplyId = row.find('td:eq(1)').data('supply-id');
    let newQuantity = row.find('input.new-quantity').val();
    let currentQuantity = row.find('td:eq(3)').text(); // Get the current quantity from the table

    // Check if the new quantity is the same as the current one
    if (newQuantity === currentQuantity) {
        Swal.fire({
            icon: 'error',
            title: 'Kuantiti baru sama dengan kuantiti semasa!',
            showConfirmButton: true,
            timer: 2000 // 3 seconds
        });
        return;
    }

    // Make an AJAX request to update the quantity in the database
    $.ajax({
        url: 'update_quantity.php',
        type: 'POST',
        data: {
            supply_id: supplyId,
            new_quantity: newQuantity
        },
        success: function (response) {
            if (response === 'Success') {
                // Update the quantity and status badge
                let quantityCell = row.find('td:eq(3)');
                quantityCell.text(newQuantity);
                let updatedStatusBadge;
                if (newQuantity == 0) {
                    updatedStatusBadge = '<span class="badge badge-danger">Habis</span>';
                } else if (newQuantity < 100) {
                    updatedStatusBadge = '<span class="badge badge-warning">Kurang</span>';
                } else {
                    updatedStatusBadge = '<span class="badge badge-success">Mencukupi</span>';
                }
                row.find('td:eq(2)').html(updatedStatusBadge);
                Swal.fire({
                    icon: 'success',
                    title: 'Berjaya kemas kini kuantiti!',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000 // 3 seconds
                });
            } else {
                alert('Error updating quantity: ' + response);
            }
        }
    });
});
        
    // Function to append row to table body
    function appendRowToTable(tableBody, supply, rowNumber) {
        let statusBadge;
        if (supply.stock == 0) {
            statusBadge = '<span class="badge badge-danger">Habis</span>';
        } else if (supply.stock < 100) {
            statusBadge = '<span class="badge badge-warning">Kurang</span>';
        } else {
            statusBadge = '<span class="badge badge-success">Mencukupi</span>';
        }

        let row = `<tr>
            <td>${rowNumber}</td>
            <td data-supply-id="${supply.supply_id}">${supply.supply_name}</td>
            <td>${statusBadge}</td>
            <td>${supply.stock}</td>
            <td>
                <div class="d-flex align-items-center">
                    <input type="number" class="new-quantity form-control mr-2" min="0" value="${supply.stock}">
                    <button type="button" class="btn btn-primary save-btn">
                        <span class="bi bi-pencil-square"></span>
                    </button>
                </div>
            </td>
        </tr>`;
        tableBody.append(row);
    }
            });
    });


     $('#btnLogout').click(function (e) {
    e.preventDefault();
    
    $.ajax({
        url: 'logout.php',
        type: 'POST',
        dataType: 'json',
        success: function (response) {
            if (response.success) {
                // If logout is successful, redirect to index.html
                window.location.href = 'index.html';
            } else {
                alert('Logout failed. Please try again.');
            }
        },
        error: function () {
            alert('An error occurred while trying to log out.');
        }
    });
});

});
 
    
    
    
</script>

    <!-- jQuery -->
    <script src="css/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="css/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="css/adminlte.min.js"></script>
    </div>
    </section>
    </div>
    </div>
</body>

</html>
