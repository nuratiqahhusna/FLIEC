<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> Health Record | Dashboard</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="css/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="css/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="css/daterangepicker.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    
    <style>
    .custom-modal-size {
        max-width: 70% !important; /* Set the desired width percentage or fixed value */
    }
    .custom-modal-content {
            height: 87vh; /* Adjust the height, vh means viewport height */
            overflow-y: auto; /* Ensure the content is scrollable if it overflows */
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            grid-gap: 10px; /* Adjust the spacing between checkboxes */
        }
    .content-wrapper {
        padding-top: 60px; /* Add padding to prevent content from being hidden behind the navbar */
    }
        
    </style>

</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

         <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light fixed-top">
    <!-- Left navbar links -->
    <ul class="navbar-nav mr-auto">
        <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="bi bi-list"></i></a>
        </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href='#' id="btnLogout"><i class="bi bi-power"></i></a>
        </li>
    </ul>
    </nav>

      
  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="index.html" class="brand-link">
      <img src="img/fliec_logo.jpg" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">FLIEC</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user panel (optional) -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="img/pkdbp.jpg" class="img-circle elevation-2" alt="User Image">
        </div>
        <div class="info">
          <a href="#" class="d-block">PKDBP</a>
        </div>
      </div>

      <!-- SidebarSearch Form -->

       <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
          <li class="nav-item">
            <a href="dashboard_KKM.html" class="nav-link">
              <p>
                LAMAN UTAMA
              </p>
            </a>
              <li class="nav-item">
                <a href="staffDelegation_KKM.html" class="nav-link">
                  <p>AGIHAN TUGASAN KAKITANGAN</p>
                </a>
              </li>
           <li class="nav-item">
                <a href="./victimHealth.html" class="nav-link active">
                  <p>REKOD KESIHATAN MANGSA</p>
                </a>
          </li>
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>
  

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">REKOD KESIHATAN MANGSA</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="dashboard_KKM.html">Laman Utama</a></li>
              <li class="breadcrumb-item active">Rekod Kesihatan Mangsa</li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->
    
<div class="content">
  <div class="container mt-3">
        <div class="form-row">
            <div class="col">
                 <select id="districtDropdown" class="form-control">
                    <option value="" selected disabled>PILIH MUKIM</option>
                    <option value="1">CHAAH BAHRU</option>
                    <option value="2">KAMPUNG BAHRU</option>
                    <option value="3">LINAU</option>
                    <option value="4">SRI GADING</option>
                    <option value="5">LUBOK</option>
                    <option value="6">SIMPANG KANAN</option>
                    <option value="7">SIMPANG KIRI</option>
                    <option value="8">SRI MEDAN</option>
                    <option value="9">TANJUNG SEMBRONG</option>
                    
                </select>
            </div>
            <div class="col">
                <select id="cityDropdown" class="form-control">
                    <option selected disabled>PILIH PPS</option>
                </select>
            </div>
                <div class="col">
                <button id="submitBtn" class="btn" style="background-color:#1B4A7D; color: white;">Lihat Rekod Kesihatan</button>
            </div>
        </div>
         <div id="result" class="mt-1"></div>
         <!-- TABLE -->
        <div class="container mt-5" id="tableSection" style="display: none;">
            <div class="col-sm-12">
                <div class="card card-primary">
                    <div class="card-header"  style="background-color: #1E3A57; color: white;">
                        <h3 class="card-title"></h3>
                    </div>
                    <div class="card-body">
                        <table id="infoTable" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>NO K/P</th>
                                    <th>Umur</th>
                                    <th>Jantina</th>
                                    <th>Nota</th>
                                    <th>Sebelum Diagnosis</th>
                                    <th>Selepas Diagnosis</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be inserted here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
      </div>
      <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
   <div class="modal-dialog custom-modal-size">
        <div class="modal-content custom-modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Selepas Diagnosis</h5>
                <button type="button" id="closeIcon" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label for="note">Nota Selepas Diagnosis</label>
                        <input type="text" id="note" class="form-control" id="afterCheckupInput">
                    </div>
                    <div>
                        <label for="diseaseCheckbox">Penyakit Selepas Diagnosis</label>
                    </div>
                    <div class="form-group checkbox-grid"> <!-- Container for inline checkboxes -->
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease1" value="AGE">
                            <label class="form-check-label" for="disease1">AGE</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease2" value="ARI / URTI">
                            <label class="form-check-label" for="disease2">ARI / URTI</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease3" value="KONJUNKTIVITIS">
                            <label class="form-check-label" for="disease3">KONJUNKTIVITIS</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease4" value="PENYAKIT KULIT">
                            <label class="form-check-label" for="disease4">PENYAKIT KULIT</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease5" value="DENGGI">
                            <label class="form-check-label" for="disease">DENGGI</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease6" value="HFMD">
                            <label class="form-check-label" for="disease6">HFMD</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease7" value="TIFOID">
                            <label class="form-check-label" for="disease7">TIFOID</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease8" value="HEPATITIS A">
                            <label class="form-check-label" for="disease8">HEPATITIS A</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease9" value="KOLERA">
                            <label class="form-check-label" for="disease9">KOLERA</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease10" value="CHICKEN POX">
                            <label class="form-check-label" for="disease10">CHICKEN POX</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease11" value="LEPTOSPIROSIS">
                            <label class="form-check-label" for="disease11">LEPTOSPIROSIS</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease12" value="MELIOIDOSIS">
                            <label class="form-check-label" for="disease12">MELIOIDOSIS</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease13" value="DEMAM (TIADA GEJALA LAIN)">
                            <label class="form-check-label" for="disease13">DEMAM (TIADA GEJALA LAIN)</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease14" value="OTHER NOTIFIABLE DISEASES">
                            <label class="form-check-label" for="disease14">OTHER NOTIFIABLE DISEASES</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease15" value="DIABETES MELITUS DAN HYPERTENSION">
                            <label class="form-check-label" for="disease15">DIABETES MELITUS DAN HYPERTENSION</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease16" value="HYPERTENSION">
                            <label class="form-check-label" for="disease1">HYPERTENSION</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="disease17" value="DIABETES MELITUS">
                            <label class="form-check-label" for="disease1">DIABETES MELITUS</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" style="background-color:#1B4A7D; color: white;" id="saveChangesBtn">Simpan Perubahan</button>
            </div>
        </div>
    </div>
</div>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Bootstrap 4 -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
 <script>

  $(document).ready(function () {
    // Event listener for district dropdown change
    $('#districtDropdown').on('change', function () {
        const pps_district = $(this).val();

        if (pps_district) {
            const formData = new FormData();
            formData.append('pps_district', pps_district);

            fetch('fetch_pps.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const cityDropdown = document.getElementById('cityDropdown');
                cityDropdown.innerHTML = '<option value="" disabled selected>PILIH PPS</option>';

                data.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.pps_id;
                    option.text = city.pps_name;
                    cityDropdown.add(option);
                });
            })
            .catch(error => console.error('Error:', error));
        }
    });
  });

    $('.modal-header .close, #editModal .modal-footer .btn-secondary').on('click', function () {
        $('#editModal').modal('hide');
    });

    // Ensure the modal close buttons work and clear data
    $('#editModal').on('hidden.bs.modal', function () {
        $('#afterCheckupInput').val(''); // Clear the input field
        $('#note').val(''); // Clear the note input
        $('#editModal').removeData('currentRow'); // Remove the stored data
        $('.form-check-input').prop('checked', false); // Uncheck all checkboxes
    });

   // Function to handle opening modal for editing
function openEditModal(row) {
    // Fetch initial checkbox state from the database
    $.ajax({
        url: 'fetch_checkbox_state.php',
        type: 'GET',
        data: {
            victim_ic_no: row.victim_ic_no
        },
        dataType: 'json',
        success: function (response) {
            if (response.checkbox_state && response.checkbox_state.length > 0) {
                // Iterate over each checkbox
                $('.form-check-input').each(function () {
                    const checkboxValue = $(this).val();
                    // Check if the checkbox value exists in the fetched checkbox state
                    if (response.checkbox_state.includes(checkboxValue)) {
                        $(this).prop('checked', true);
                    } else {
                        $(this).prop('checked', false);
                    }
                });
            }

            // Set other input field values
            $('#afterCheckupInput').val(row.after_checkup);
            $('#note').val(row.note);
            
            // Store current row data in the modal
            $('#editModal').data('currentRow', row);
            // Show modal
            $('#editModal').modal('show');
        },
        error: function (xhr, status, error) {
            console.error(xhr.responseText);
            alert('An error occurred while fetching initial checkbox state. Please try again.');
        }
    });
}

// Save changes button event listener
$('#saveChangesBtn').on('click', function () {
    var newValue = $('#afterCheckupInput').val();
    var currentRow = $('#editModal').data('currentRow'); // Retrieve the current row data

    // Gather the values of the checked checkboxes
    var checkedValues = [];
    $('.form-check-input:checked').each(function () {
        checkedValues.push($(this).val());
    });

    // Save the new value and checked checkboxes to the database using AJAX
    $.ajax({
        url: 'saveDataHealth.php',
        type: 'POST',
        data: {
            victim_ic_no: currentRow.victim_ic_no,
            after_checkup: newValue,
            note: $('#note').val(), // Get the value of the note input
            checkboxes: checkedValues // Send the array of checked checkboxes
        },
        dataType: 'json',
        success: function (response) {
            if (response.success) {
                // Update the row in the table
                $('#infoTable tbody tr').each(function () {
                    var row = $(this);
                    if (row.find('td').eq(1).text() === currentRow.victim_ic_no) {
                        // Display checked checkboxes' values in the last column
                        var selepasTd = row.find('td').eq(6);
                        selepasTd.empty(); // Clear the content
                        var checkedValuesStr = checkedValues.join(', ');
                        selepasTd.text(checkedValuesStr);

                        // Ensure the pencil icon is only added once
                        if (!selepasTd.find('i').length) {
                            var editIcon = $('<i class="bi bi-pencil" style="cursor: pointer; float: right;"></i>');
                            selepasTd.append(editIcon);

                            // Re-attach the event listener to the new icon
                            editIcon.on('click', function () {
                                openEditModal(currentRow);
                            });
                        }
                    }
                });
                currentRow.after_checkup = newValue; // Update row data
                $('#editModal').modal('hide'); // Hide modal

                // Display success toast
                Swal.fire({
                    icon: 'success',
                    title: 'Data telah dikemaskini!',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000 // 2 seconds
                });
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function (xhr, status, error) {
            console.error(xhr.responseText);
            alert('An error occurred while saving the data. Please try again.');
        }
    });
});



    // Event listener for submit button
    $('#submitBtn').on('click', function () {
        const selectedDistrict = document.getElementById('districtDropdown').value;
        const selectedCity = document.getElementById('cityDropdown').value;
        const resultElement = document.getElementById('result');
        const tableSection = document.getElementById('tableSection');

        // Clear previous error messages
        resultElement.innerHTML = '';

        if (selectedDistrict && selectedCity) {
            // Make AJAX request to fetch data
            $.ajax({
                url: 'fetch_data_health.php',
                type: 'GET',
                data: {
                    pps_district: selectedCity
                },
                dataType: 'json',
                success: function (data) {
                    var tbody = $('#infoTable tbody');
                    tbody.empty();

                    if (data.length > 0) {
                        data.forEach(function (row) {
                            var tr = $('<tr>');
                            tr.append($('<td>').text(row.victim_name));
                            tr.append($('<td>').text(row.victim_ic_no));
                            tr.append($('<td>').text(row.victim_age));
                            tr.append($('<td>').text(row.victim_gender));
                            tr.append($('<td>').text(row.note));
                            tr.append($('<td>').text(row.disease_name));
                            
                            // Add "Selepas" column with pencil icon
                            var selepasTd = $('<td>').text(row.after_checkup);
                            var editIcon = $('<i class="bi bi-pencil" style="cursor: pointer; float: right;"></i>');
                            selepasTd.append(editIcon);
                            tr.append(selepasTd);
                            tbody.append(tr);

                            // Event listener for edit icon
                            editIcon.on('click', function () {
                                openEditModal(row);
                            });
                        });

                        // Show the table section
                        tableSection.style.display = 'block';
                        resultElement.innerHTML = ''; // Clear any previous error message
                    } else {
                        // No data available for the selected city
                        Swal.fire({
                            icon: 'error',
                            title: 'Tiada data bagi PPS yang telah dipilih.',
                            showConfirmButton: false,
                            timer: 2000 // 2 seconds
                        });
                        tableSection.style.display = 'none';
                    }
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                    resultElement.innerHTML = '<p class="text-danger">An error occurred while fetching the data. Please try again.</p>';
                    tableSection.style.display = 'none';
                }
            });
        } else {
             if (!selectedDistrict) {
                Swal.fire({
                    icon: 'error',
                    title: 'Sila pilih Mukim dan PPS',
                    showConfirmButton: false,
                    timer: 2000 // 2 seconds
                });
                return;
            }

            if (!selectedCity) {
                Swal.fire({
                    icon: 'error',
                    title: 'Sila pilih PPS',
                    showConfirmButton: false,
                    timer: 2000 // 2 seconds
                });
                return;
            }
            // Hide the table section
            tableSection.style.display = 'none';
        }
    });

    // Event listener for logout button
   
     $('#btnLogout').click(function (e) {
    e.preventDefault();
    
    $.ajax({
        url: 'logout.php',
        type: 'POST',
        dataType: 'json',
        success: function (response) {
            if (response.success) {
                // If logout is successful, redirect to index.html
                window.location.href = 'index.html';
            } else {
                alert('Logout failed. Please try again.');
            }
        },
        error: function () {
            alert('An error occurred while trying to log out.');
        }
    });
});

    $('#closeIcon').on('click', function () {
        $('#editModal').modal('hide'); // Hide modal
    });

    // Reset district dropdown to selected-disabled value when document is loaded
    $('#districtDropdown').prop('selectedIndex', 0);
    $('#cityDropdown').prop('selectedIndex', 0);
</script>

<!-- jQuery -->
<script src="css/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="css/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="css/bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<script src="css/Chart.min.js"></script>
<!-- Sparkline -->
<script src="css/sparkline.js"></script>
<!-- JQVMap -->
<script src="css/jquery.vmap.min.js"></script>
<script src="css/jquery.vmap.usa.js"></script>
<!-- jQuery Knob Chart -->
<script src="css/jquery.knob.min.js"></script>
<!-- daterangepicker -->
<script src="css/moment.min.js"></script>
<script src="css/daterangepicker.js"></script>
<!-- overlayScrollbars -->
<script src="css/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="css/adminlte.js"></script>
<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<script src="css/dashboard.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    </div>
    </body>
</html>