<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FLIEC | Dashboard</title>

  <link rel="stylesheet" href="all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="adminlte.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="daterangepicker.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<style>
    .content-wrapper {
        padding-top: 60px; /* Add padding to prevent content from being hidden behind the navbar */
    }
    
    #cardsContainer, #cardsContainer2, #cardsContainer3 {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%; /* Full height of the column */
}
table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td, tr {
            border: 1px solid #dddddd;
            text-align: center;
            padding: 8px;
            font-size: 12px;
        }
        th {
            background-color: #f2f2f2;
        }
     #customText {
            display: none;
            font-weight: bold; /* Make the text bold */
            margin-bottom: 20px; /* Add space below the custom text */
            font-size: 12px;
        }

  
</style>
  <!-- summernote -->
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light fixed-top">
    <!-- Left navbar links -->
    <ul class="navbar-nav mr-auto">
        <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="bi bi-list"></i></a>
        </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href='#' id="btnLogout"><i class="bi bi-power"></i></a>
        </li>
    </ul>
    </nav>

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="index.html" class="brand-link">
      <img src="fliec_logo.jpg" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">FLIEC</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user panel (optional) -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="jkmLogo.png" class="img-circle elevation-2" alt="User Image">
        </div>
        <div class="info">
          <a href="#" class="d-block">JKM</a>
        </div>
      </div>

      <!-- SidebarSearch Form -->

      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
          <li class="nav-item">
            <a href="#" class="nav-link active">
              <p>
                STATISTIK PPS
              </p>
            </a>
              <li class="nav-item">
                <a href="iBantuan.html" class="nav-link">
                  <p>PERMINTAAN BEKALAN</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="staffDelegation_JKM.html" class="nav-link">
                  <p>AGIHAN TUGASAN KAKITANGAN</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="infoMangsa.html" class="nav-link">
                  <p>MAKLUMAT MANGSA</p>
                </a>
          </li>
          <li class="nav-item">
              <a href="addPPS.html" class="nav-link">
                  <p>PENAMBAHAN PUSAT</p>
                </a>
          </li>
          <li class="nav-item">
              <a href="ppsStatus.html" class="nav-link">
                  <p>STATUS PPS</p>
                </a>
          </li>
           <li class="nav-item">
                          <a href="victimHealth_JKM.html" class="nav-link">
                              <p>REKOD KESIHATAN MANGSA</p>
                            </a>
                      </li>
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>
  
           
            <!-- /.card -->
            <!-- jQuery -->
<script src="jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<script src="Chart.min.js"></script>
<!-- AdminLTE App -->
<!-- AdminLTE for demo purposes -->
<!-- Page specific script -->

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">STATISTIK PPS</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Statistik PPS</a></li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->
    
    <div class="content">
     <div class="container mt-3">
        <div class="form-row">
            <div class="col">
                <select id="districtDropdown" class="form-control">
                    <option value ="" selected disabled>PILIH MUKIM</option>
                    <option value="1">CHAAH BAHRU</option>
                    <option value="2">KAMPUNG BAHRU</option>
                    <option value="3">LINAU</option>
                    <option value="4">SRI GADING</option>
                    <option value="5">LUBOK</option>
                    <option value="6">SIMPANG KANAN</option>
                    <option value="7">SIMPANG KIRI</option>
                    <option value="8">SRI MEDAN</option>
                    <option value="9">TANJUNG SEMBRONG</option>
                    
                </select>
            </div>
           <div class="col">
                <select id="cityDropdown" class="form-control">
                    <option selected disabled>PILIH PPS</option>
                </select>
            </div>
               <div class="mr-3 ml-3 mb-3">
                <button id="submitBtn" class="btn" style="background-color:#1B4A7D; color: white;">Lihat Infografik</button>
                </div>
                <div>
                <button class="btn" style="background-color:#1B4A7D; color: white;" id="downloadBtn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-pdf" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM1.6 11.85H0v3.999h.791v-1.342h.803q.43 0 .732-.173.305-.175.463-.474a1.4 1.4 0 0 0 .161-.677q0-.375-.158-.677a1.2 1.2 0 0 0-.46-.477q-.3-.18-.732-.179m.545 1.333a.8.8 0 0 1-.085.38.57.57 0 0 1-.238.241.8.8 0 0 1-.375.082H.788V12.48h.66q.327 0 .512.181.185.183.185.522m1.217-1.333v3.999h1.46q.602 0 .998-.237a1.45 1.45 0 0 0 .595-.689q.196-.45.196-1.084 0-.63-.196-1.075a1.43 1.43 0 0 0-.589-.68q-.396-.234-1.005-.234zm.791.645h.563q.371 0 .609.152a.9.9 0 0 1 .354.454q.118.302.118.753a2.3 2.3 0 0 1-.068.592 1.1 1.1 0 0 1-.196.422.8.8 0 0 1-.334.252 1.3 1.3 0 0 1-.483.082h-.563zm3.743 1.763v1.591h-.79V11.85h2.548v.653H7.896v1.117h1.606v.638z"/>
                </svg></button>
                </div>
        </div>
       </div>
        <div class="container mt-2">
         <div id="result" class="mt-1"></div>
         <div class= "row">
        <div class="col-sm-4" id="cardsContainer" style="display: none;"></div>
        <div class="col-sm-4" id="cardsContainer2" style="display: none;"></div>
        <div class="col-sm-4" id="cardsContainer3" style="display: none;"></div>
        </div>
        <section id="chartSection" style="display: none;">
           <div class="row">
               <div class="col-sm-4 mb-3">
                <div class="card">
                    <div class="card-header" style="background-color: #1E3A57; color: white;">
                        <h3 class="card-title">Taburan Jantina</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            <canvas id="barChart" style="min-height: 250px; height: 250px; max-height: 250px; width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
              <div class="col-sm-4">
                <div class="card card-success">
                    <div class="card-header"  style="background-color: #1E3A57; color: white;">
                        <h3 class="card-title">Statistik Kapasiti PPS</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            <canvas id="barChartStatistics" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
               <div class="col-sm-4">
                <div class="card card-success">
                    <div class="card-header"  style="background-color: #1E3A57; color: white;">
                        <h3 class="card-title">Taburan Kategori Umur</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            <canvas id="barChartAge" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="card card-success">
                    <div class="card-header"  style="background-color: #1E3A57; color: white;">
                        <h3 class="card-title">Taburan Kategori Khas</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            <canvas id="barChartCateg" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <div class="card card-success">
                    <div class="card-header"  style="background-color: #1E3A57; color: white;">
                        <h3 class="card-title">Taburan Penyakit Mangsa (Sebelum Diagnosis)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            <canvas id="barChartDisease"style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-12">
                <div class="card card-success">
                    <div class="card-header"  style="background-color: #1E3A57; color: white;">
                        <h3 class="card-title">Taburan Penyakit Mangsa (Selepas Diagnosis)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            <canvas id="barChartAfterCheckup" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
           </div>
        </section>
         </div>
    </div>
    </div>
    
       <!-- Hidden container for PDF generation -->
<div id="pdfContainer" style="display: none;">
    <div id="content">
        <div id="customText"></div>
        <div id="result" class="mt-1"></div>
        <table border="1">
            <thead>
                <tr>
                    <th>Kategori</th>
                    <th>Bilangan</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Mangsa Banjir</td>
                    <td id="victimCount"></td>
                </tr>
                <tr>
                    <td>Keluarga Mangsa Banjir</td>
                    <td id="victimHeadCount"></td>
                </tr>
                <tr>
                    <td>Kapasiti PPS Tersedia</td>
                    <td id="ppsCapacity"></td>
                </tr>
                <tr>
                    <td>Peratus Statistik PPS</td>
                    <td id="percentageCapacity"></td>
                </tr>
                <tr>
                    <td>Lelaki</td>
                    <td id="maleCount"></td>
                </tr>
                <tr>
                    <td>Perempuan</td>
                    <td id="femaleCount"></td>
                </tr>
                <tr>
                    <td>Jumlah Mangsa Mengikut Umur</td>
                    <td>
                        <ul id="ageCategoryCounts"></ul>
                    </td>
                </tr>
                <tr>
                    <td>Jumlah Mangsa Mengikut Kategori</td>
                    <td>
                        <ul id="generalCategoryCounts"></ul>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
            
 <!-- Vendor JS Files -->
  <script src="aos.js"></script>
  <script src="bootstrap.bundle.min.js"></script>
  <script src="glightbox.min.js"></script>
  <script src="isotope.pkgd.min.js"></script>
  <script src="swiper-bundle.min.js"></script>
  <script src="noframework.waypoints.js"></script>
  <script src="validate.js"></script>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      
      
   <script>

  document.getElementById('districtDropdown').addEventListener('change', function() {
    const pps_district = this.value;

    if (pps_district) {
        const formData = new FormData();
        formData.append('pps_district', pps_district);

        fetch('fetch_pps.php', {
            method: 'POST', // Change method to POST
            body: formData // Use FormData to send data
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const cityDropdown = document.getElementById('cityDropdown');
            cityDropdown.innerHTML = '<option value="" disabled selected>PILIH PPS</option>'; // Clear previous options and add default

            data.forEach(city => {
                const option = document.createElement('option');
                option.value = city.pps_id;
                option.text = city.pps_name;
                cityDropdown.add(option);
            });
        })
        .catch(error => console.error('Error:', error));
    }
});
        
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('districtDropdown').selectedIndex = 0;
    document.getElementById('cityDropdown').selectedIndex = 0;

    // Event listener for city dropdown change
    document.getElementById('cityDropdown').addEventListener('change', function() {
        const selectedCityName = this.options[this.selectedIndex].text;
        const customText = document.getElementById('customText');

        // Update the custom text based on the selected city
        customText.innerHTML = `Statistik PPS bagi ${selectedCityName}`;
    });

   document.getElementById('downloadBtn').addEventListener('click', function() {
    const selectedCityElement = document.getElementById('cityDropdown');
    const selectedCity = selectedCityElement.value;
    const selectedCityName = selectedCityElement.options[selectedCityElement.selectedIndex].text;
    const selectedDistrict = document.getElementById('districtDropdown').value;
    const resultElement = document.getElementById('result');
    const customText = document.getElementById('customText');

    // Show the custom text element
    customText.style.display = 'block';

    // Clear previous error messages
    resultElement.innerHTML = '';

    if (selectedDistrict && selectedCity) {
        // Make AJAX request to fetch data
        $.ajax({
            url: 'fetch_data_other.php',
            type: 'GET',
            data: {
                pps_id: selectedCity
            },
            dataType: 'json',
            success: function(data) {
                clearPreviousData();

                if (data.length === 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Tiada data bagi PPS yang telah dipilih.',
                        showConfirmButton: false,
                        timer: 3000
                    });
                } else {
                    var maleCount = 0;
                    var femaleCount = 0;
                    var ageCategoryCounts = {
                        'DEWASA': 0,
                        'KANAK-KANAK': 0,
                        'WARGA EMAS': 0,
                        'BAYI': 0
                    };
                    var generalCategoryCounts = {
                        'OKU': 0,
                        'MENGANDUNG': 0,
                        'PEMBEDAHAN': 0,
                        'KRONIK/TERLANTAR': 0
                    };
                    
                     var categoryDisplayNames = {
                        'DEWASA': 'Dewasa',
                        'KANAK-KANAK': 'Kanak-kanak',
                        'OKU': 'OKU',
                        'WARGA EMAS': 'Warga Emas',
                        'MENGANDUNG': 'Mengandung',
                        'PEMBEDAHAN': 'Pembedahan',
                        'BAYI': 'Bayi',
                        'KRONIK/TERLANTAR': 'Kronik/Terlantar'
                    };

                    data.forEach(function(row) {
                        if (row.victim_gender == 'L') {
                            maleCount++;
                        } else {
                            femaleCount++;
                        }

                        // Process age category counts
                        var ageCategories = row.victim_age_categ.split(', ');
                        ageCategories.forEach(function(category) {
                            if (ageCategoryCounts.hasOwnProperty(category)) {
                                ageCategoryCounts[category]++;
                            }
                        });

                        // Process general category counts
                        var generalCategories = row.victim_special_categ.split(', ');
                        generalCategories.forEach(function(category) {
                            if (generalCategoryCounts.hasOwnProperty(category)) {
                                generalCategoryCounts[category]++;
                            }
                        });
                    });

                    document.getElementById('maleCount').textContent = maleCount;
                    document.getElementById('femaleCount').textContent = femaleCount;

                    populateCategoryCounts('ageCategoryCounts', ['DEWASA', 'KANAK-KANAK', 'WARGA EMAS', 'BAYI'], ageCategoryCounts, categoryDisplayNames);
                    populateCategoryCounts('generalCategoryCounts', ['OKU', 'MENGANDUNG', 'PEMBEDAHAN', 'KRONIK/TERLANTAR'], generalCategoryCounts, categoryDisplayNames);

                    // Fetch capacity data and generate PDF
                    fetchCapacityData(selectedCity).then(() => {
                        // Make sure customText is updated before generating the PDF
                        document.getElementById('customText').innerHTML = `Statistik PPS bagi ${selectedCityName}`;
                        generatePDF(selectedCityName);
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching data:', error);
            }
        });
    } else {
        alert('Please select both district and city.');
    }
});

    function clearPreviousData() {
        document.getElementById('maleCount').textContent = '';
        document.getElementById('femaleCount').textContent = '';
        document.getElementById('victimCount').textContent = '';
        document.getElementById('ppsCapacity').textContent = '';
        document.getElementById('victimHeadCount').textContent = '';
        document.getElementById('percentageCapacity').textContent = '';

        document.getElementById('ageCategoryCounts').innerHTML = '';
        document.getElementById('generalCategoryCounts').innerHTML = '';
    }

    function populateCategoryCounts(containerId, categories, counts, displayNames) {
        const container = document.getElementById(containerId);
        categories.forEach(function(category) {
            const count = counts[category];
            const listItem = document.createElement('li');
            const displayName = displayNames[category] || category;
            listItem.textContent = `${displayName}: ${count}`;
            container.appendChild(listItem);
        });
    }

    function fetchCapacityData(selectedCity) {
        return fetch(`fetch_data.php?pps_id=${selectedCity}`)
            .then(response => response.json())
            .then(capacityData => {
                console.log('Capacity data:', capacityData);
                if (capacityData.error) {
                    console.error('Error fetching capacity data:', capacityData.error);
                    return;
                }

                var ppsCapacity = capacityData.pps_capacity;
                var usedCapacity = capacityData.total_records;
                var totalHeadFam = capacityData.total_records_fam;
                var percentageCapacity = capacityData.percentage_capacity;

                document.getElementById('victimCount').textContent = usedCapacity;
                document.getElementById('ppsCapacity').textContent = ppsCapacity - usedCapacity;
                document.getElementById('victimHeadCount').textContent = totalHeadFam;
                document.getElementById('percentageCapacity').textContent = percentageCapacity;
            })
            .catch(error => console.error('Error fetching capacity data:', error));
    }

    function generatePDF(selectedCityName) {
        const pdfContainer = document.getElementById('pdfContainer');
        pdfContainer.style.display = 'block'; // Show the hidden container
        const tempContainer = pdfContainer.cloneNode(true); // Clone the container
        tempContainer.id = ''; // Remove the ID to prevent conflicts

        // Ensure the custom text is set before generating the PDF
        const customText = document.getElementById('customText');
        customText.style.display = 'block'; // Ensure custom text is visible

        // Configure html2pdf options
        const options = {
            margin: 1,
            filename: `Statistik_PPS_bagi_${selectedCityName}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        // Generate the PDF
        html2pdf().from(tempContainer).set(options).save().then(() => {
            pdfContainer.style.display = 'none'; // Hide the container again
            customText.style.display = 'none'; // Hide custom text after PDF generation
        });
    }
});

     
document.getElementById('submitBtn').addEventListener('click', function() {
    const selectedDistrict = document.getElementById('districtDropdown').value;
    const selectedCity = document.getElementById('cityDropdown').value;
    const resultElement = document.getElementById('result');
    const chartSection = document.getElementById('chartSection');
    const cardsContainer = document.getElementById('cardsContainer');
    const cardsContainer2 = document.getElementById('cardsContainer2');
    const cardsContainer3 = document.getElementById('cardsContainer3');
    
    // Clear previous error messages
    resultElement.innerHTML = '';
    cardsContainer.innerHTML = '';
    cardsContainer2.innerHTML = '';
    cardsContainer3.innerHTML = '';
    
    
    if (selectedDistrict && selectedCity) {
        // Make AJAX request to fetch data
        $.ajax({
            url: 'fetch_data_other.php',
            type: 'GET',
            data: {
                pps_id: selectedCity
            },
            dataType: 'json',
            success: function(data) {
                // Process the data as required
                if (data.length === 0) {
                   Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Tiada data bagi PPS yang telah dipilih.',
                    //toast: true,
                    showConfirmButton: false,
                    timer: 3000
                   });
                    // Hide the chart section
                    chartSection.style.display = 'none';
                    cardsContainer.style.display ='none';
                    cardsContainer2.style.display = 'none';
                    cardsContainer3.style.display = 'none';
                    
                } else {
                    
                    //destroyCharts();
                    
                    var maleCount = 0;
                    var femaleCount = 0;
                    var ageCategoryCounts = {
                        'DEWASA': 0,
                        'KANAK-KANAK': 0,
                        'WARGA EMAS': 0,
                        'BAYI': 0
                    };
                    var generalCategoryCounts = {
                        'OKU': 0,
                        'MENGANDUNG': 0,
                        'PEMBEDAHAN': 0,
                        'KRONIK/TERLANTAR': 0
                    };
                    var diseaseCounts = {
                            'AGE': 0,
                            'ARI/URTI': 0,
                            'KONJUNKTIVITIS': 0,
                            'PENYAKIT KULIT': 0,
                            'DEMAM (TIADA GEJALA LAIN)': 0,
                            'HFMD': 0,
                            'TIFOID': 0,
                            'HEPATITIS A': 0,
                            'KOLERA': 0,
                            'CHICKEN POX': 0,
                            'LEPTOSPIROSIS': 0,
                            'MELIOIDOSIS': 0,
                            'DENGGI': 0,
                            'OTHER': 0,
                            'DIABETES MELITUS': 0,
                            'HYPERTENSION': 0,
                            'DIABETES MELITUS DAN HYPERTENSION': 0
                        };
                        var afterCheckupCounts = {
                            'AGE': 0,
                            'ARI/URTI': 0,
                            'KONJUNKTIVITIS': 0,
                            'PENYAKIT KULIT': 0,
                            'DEMAM (TIADA GEJALA LAIN)': 0,
                            'HFMD': 0,
                            'TIFOID': 0,
                            'HEPATITIS A': 0,
                            'KOLERA': 0,
                            'CHICKEN POX': 0,
                            'LEPTOSPIROSIS': 0,
                            'MELIOIDOSIS': 0,
                            'DENGGI': 0,
                            'OTHER': 0,
                            'DIABETES MELITUS': 0,
                            'HYPERTENSION': 0,
                            'DIABETES MELITUS DAN HYPERTENSION': 0
                        };
                    console.log('Data received from server:', data);
                    
                    data.forEach(function(row) {
                        if (row.victim_gender == 'L') {
                            maleCount++;
                        } else {
                            femaleCount++;
                        }

                         // Process age category counts
                        var ageCategories = row.victim_age_categ.split(', ');
                        ageCategories.forEach(function(category) {
                            if (ageCategoryCounts.hasOwnProperty(category)) {
                                ageCategoryCounts[category]++;
                            }
                        });

                        // Process general category counts
                        var generalCategories = row.victim_special_categ.split(', ');
                        generalCategories.forEach(function(category) {
                            if (generalCategoryCounts.hasOwnProperty(category)) {
                                generalCategoryCounts[category]++;
                            }
                        });
                        
                        var diseases = row.disease_name.split(', ');
                        
                        diseases.forEach(function(disease) {
                            if (diseaseCounts.hasOwnProperty(disease)) {
                                diseaseCounts[disease]++;
                            }
                        });
                        
                        // Count occurrences of each after_checkup status
                        var afterCheckups = row.after_checkup.split(', ');
                        afterCheckups.forEach(function(checkup) {
                            if (afterCheckupCounts.hasOwnProperty(checkup)) {
                                afterCheckupCounts[checkup]++;
                            }
                        });
                    });


                    var barChartCanvas = document.getElementById('barChart').getContext('2d');
                    var barChartOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: false
                    };
                    
                    var barChartData = {
                        labels: ['Lelaki', 'Perempuan'],
                        datasets: [{
                            label: 'Gender Distribution',
                            backgroundColor: ['rgba(60,141,188,0.9)', 'rgba(255,99,132,0.9)'],
                            borderColor: ['rgba(60,141,188,0.8)', 'rgba(255,99,132,0.8)'],
                            borderWidth: 1,
                            data: [maleCount, femaleCount]
                        }]
                    };
                    
                    fetch(`fetch_data.php?pps_id=${selectedCity}`)
                        .then(response => response.json())
                        .then(capacityData => {
                            if (capacityData.error) {
                                console.error('Error fetching capacity data:', capacityData.error);
                                return;
                            }

                            var percentageCapacity = capacityData.pps_capacity;
                            var usedCapacity = capacityData.total_records;
                        
                            var statisticsChartData = {
                                labels: ['Kapasiti Digunakan', 'Kapasiti Tersedia'],
                                datasets: [{
                                    label: 'Statistik Kapasiti PPS',
                                    backgroundColor: ['rgba(75, 192, 192, 0.9)', 'rgba(153, 102, 255, 0.9)'],
                                    borderColor: ['rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8) '],
                                    borderWidth: 1,
                                    data: [usedCapacity, percentageCapacity-usedCapacity]
                                }]
                            };

                            var statisticsChartCanvas = document.getElementById('barChartStatistics').getContext('2d');
                            new Chart(statisticsChartCanvas, {
                                type: 'pie',
                                data: statisticsChartData,
                                options: barChartOptions
                            });
                        })
                        .catch(error => console.error('Error fetching capacity data:', error));
                    
                    var ageChartData = {
                          labels: ['Kategori Umur'],
                          datasets: [
                            {
                            label: 'Dewasa', 
                            backgroundColor:'rgba(75, 192, 192, 0.9)', // Dewasa
                            borderColor: 'rgba(75, 192, 192, 1)', // Dewasa
                            borderWidth: 1,
                            data: [ageCategoryCounts['DEWASA']]
                            },
                            {
                            label: 'Kanak-Kanak', 
                            backgroundColor:'rgba(255, 159, 64, 0.9)',  // Kanak-kanak
                            borderColor:  'rgba(255, 159, 64, 1)',    // Kanak-kanak
                            borderWidth: 1,
                            data: [ageCategoryCounts['KANAK-KANAK']]
                            }, 
                            {
                            label: 'Warga Emas', 
                            backgroundColor:'rgba(54, 162, 235, 0.9)',  // Warga Emas
                            borderColor:  'rgba(54, 162, 235, 1)',    // Warga Emas
                            borderWidth: 1,
                            data: [ageCategoryCounts['WARGA EMAS']]
                            },
                            {
                            label: 'Bayi', 
                            backgroundColor:'rgba(255, 99, 132, 0.9)',   // Bayi
                            borderColor:'rgba(255, 99, 132, 1)',  // Bayi
                            borderWidth: 1,
                            data: [ageCategoryCounts['BAYI']]
                            },
                          ]
                    }

                    var categChartData = {
                        labels: ['Kategori Khas'],
                        datasets: [
                            {
                            label: 'OKU', 
                            backgroundColor:'rgba(255, 205, 86, 0.9)',  // OKU
                            borderColor:  'rgba(255, 205, 86, 1)',    // OKU
                            borderWidth: 1,
                            data: [generalCategoryCounts['OKU']]
                            },
                            
                            {
                            label: 'Mengandung', 
                            backgroundColor:'rgba(153, 102, 255, 0.9)', // Mengandung
                            borderColor:  'rgba(153, 102, 255, 1)', // Mengandung
                            borderWidth: 1,
                            data: [generalCategoryCounts['MENGANDUNG']]
                            },
                            {
                            label: 'Pembedahan', 
                            backgroundColor: 'rgba(201, 203, 207, 0.9)', // Pembedahan
                            borderColor:  'rgba(201, 203, 207, 1)',   // Pembedahan
                            borderWidth: 1,
                            data: [generalCategoryCounts['PEMBEDAHAN']]
                            },
                            {
                            label: 'Kronik/Terlantar', 
                            backgroundColor: '#A7226E', // Kronik
                            borderColor:  '#A7226E',   // Kronik
                            borderWidth: 1,
                            data: [generalCategoryCounts['KRONIK/TERLANTAR']]
                            },
                            
                            ]
                    }
                    

                    var diseaseChartData = {
                    labels: ['AGE', 'ARI/URTI', 'PINK EYE', 'KULIT', 'DEMAM', 'HFMD', 'TIFOID', 'HEPATITIS A', 'KOLERA', 'CHICKEN POX', 'WEIL\'S', 'MELIOIDOSIS', 'DENGGI', 'OTHER', 'DM', 'HTN', 'DM & HTN'],
                    datasets: [{
                        label: 'Penyakit',
                        backgroundColor: [
                            '#A7226E',  // AGE
                            '#EC2049',  // ARI/URTI
                            '#F26B38',  // PINK EYE
                            '#F7DB4F',  // KULIT
                            '#2F9599',  // DEMAM
                            '#0E117A',  // HFMD
                            '#399169',  // TIFOID
                            '#12E2A4',  // HEPATITIS A
                            '#DCF516',  // KOLERA
                            'rgba(128, 0, 128, 0.9)',   // CHICKEN POX
                            'rgba(0, 128, 128, 0.9)',   // WEIL'S
                            '#3F0D12',  // MELIOIDOSIS
                            '#A71D31',  // DENGGI
                            '#F1F0CC',  // OTHER
                            '#D5BF86',   // DM
                            '#8D775F',   // HTN
                            '#95DEFF'    // DM & HTN
                        ],
                        borderColor: [
                            '#A7226E',  // AGE
                            '#EC2049',  // ARI/URTI
                            '#F26B38',  // PINK EYE
                            '#F7DB4F',  // KULIT
                            '#2F9599',  // DEMAM
                            '#0E117A',  // HFMD
                            '#399169',  // TIFOID
                            '#12E2A4',  // HEPATITIS A
                            '#DCF516',  // KOLERA
                            'rgba(128, 0, 128, 0.9)',   // CHICKEN POX
                            'rgba(0, 128, 128, 0.9)',   // WEIL'S
                            '#3F0D12',  // MELIOIDOSIS
                            '#A71D31',  // DENGGI
                            '#F1F0CC',  // OTHER
                            '#D5BF86',   // DM
                            '#8D775F',   // HTN
                            '#95DEFF'    // DM & HTN
                        ],
                        borderWidth: 1,
                        data: Object.values(diseaseCounts)
                    }]
                    }
                    
                    var afterCheckupChartData = {
                    labels: ['AGE', 'ARI/URTI', 'PINK EYE', 'KULIT', 'DEMAM', 'HFMD', 'TIFOID', 'HEPATITIS A', 'KOLERA', 'CHICKEN POX', 'WEIL', 'MELIOIDOSIS', 'DENGGI', 'OTHER', 'DM', 'HTN', 'DM & HTN'],
                    datasets: [{
                        label: 'Penyakit',
                        backgroundColor: [
                            '#A7226E',  // AGE
                            '#EC2049',  // ARI/URTI
                            '#F26B38',  // PINK EYE
                            '#F7DB4F',  // KULIT
                            '#2F9599',  // DEMAM
                            '#0E117A',  // HFMD
                            '#399169',  // TIFOID
                            '#12E2A4',  // HEPATITIS A
                            '#DCF516',  // KOLERA
                            'rgba(128, 0, 128, 0.9)',   // CHICKEN POX
                            'rgba(0, 128, 128, 0.9)',   // WEIL'S
                            '#3F0D12',  // MELIOIDOSIS
                            '#A71D31',  // DENGGI
                            '#F1F0CC',  // OTHER
                            '#D5BF86',   // DM
                            '#8D775F',   // HTN
                            '#95DEFF'    // DM & HTN
                        ],
                        borderColor: [
                           '#A7226E',  // AGE
                            '#EC2049',  // ARI/URTI
                            '#F26B38',  // PINK EYE
                            '#F7DB4F',  // KULIT
                            '#2F9599',  // DEMAM
                            '#0E117A',  // HFMD
                            '#399169',  // TIFOID
                            '#12E2A4',  // HEPATITIS A
                            '#DCF516',  // KOLERA
                            'rgba(128, 0, 128, 0.9)',   // CHICKEN POX
                            'rgba(0, 128, 128, 0.9)',   // WEIL'S
                            '#3F0D12',  // MELIOIDOSIS
                            '#A71D31',  // DENGGI
                            '#F1F0CC',  // OTHER
                            '#D5BF86',   // DM
                            '#8D775F',   // HTN
                            '#95DEFF'    // DM & HTN
                        ],
                        borderWidth: 1,
                        data: Object.values(afterCheckupCounts)
                    }]
                    }
                    
                            
                    // Show the chart section
                    chartSection.style.display = 'block';

                    new Chart(barChartCanvas, {
                        type: 'doughnut',
                        data: barChartData,
                        options: barChartOptions
                    });

                   var categChartCanvas = document.getElementById('barChartCateg').getContext('2d');
                    new Chart(categChartCanvas, {
                        type: 'bar',
                        data: categChartData,
                        options: barChartOptions
                    });
                    
                    var ageChartCanvas = document.getElementById('barChartAge').getContext('2d');
                    new Chart(ageChartCanvas, {
                        type: 'bar',
                        data: ageChartData,
                        options: barChartOptions
                    });
                    
                    var diseaseChartCanvas = document.getElementById('barChartDisease').getContext('2d');
                    new Chart(diseaseChartCanvas, {
                        type: 'bar',
                        data: diseaseChartData,
                        options: barChartOptions
                    });
                    
                    var afterCheckupChartCanvas = document.getElementById('barChartAfterCheckup').getContext('2d');
                    new Chart(afterCheckupChartCanvas, {
                        type: 'bar',
                        data: afterCheckupChartData,
                        options: barChartOptions
                    });
                    

                    // Fetch and append total record card
                    fetchTotalRecordCard(selectedCity);
                    fetchTotalRecordCardFam(selectedCity);
                    fetchStatistics(selectedCity);
                    
                }
            },
            error: function(xhr, status, error) {
                console.error(xhr.responseText);
                resultElement.innerHTML = '<p class="text-danger">An error occurred while fetching the data. Please try again.</p>';
                chartSection.style.display = 'none';
                cardsContainer.style.display = 'none';
                cardsContainer2.style.display = 'none';
                cardsContainer3.style.display = 'none';
            }
        });
    } else { if (!selectedDistrict) {
        Swal.fire({
        icon: 'error',
        title: 'Ralat!',
        text: 'SILA PILIH MUKIM DAN PPS.',
        confirmButtonText: 'OK'
    });
    } else {
        Swal.fire({
        icon: 'error',
        title: 'Ralat!',
        text: 'SILA PILIH PPS.',
        confirmButtonText: 'OK'
        }); 
    }
        chartSection.style.display = 'none';
        cardsContainer.style.display = 'none';
        cardsContainer2.style.display = 'none';
        cardsContainer3.style.display = 'none';
    }
});
      



 function fetchTotalRecordCard(selectedCity) {
    const cardsContainer = document.getElementById('cardsContainer');

    // Make AJAX request to fetch total record count
    fetch(`fetch_data.php?pps_id=${selectedCity}`, { // Construct the URL with the query string
        method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error fetching record count:', data.error);
            return;
        }

        // Clear previous cards before appending new ones
        cardsContainer.innerHTML = '';

        const card = document.createElement('div');
        card.innerHTML = `
            <div class="small-box" style="background-color: #DBECF4;" " text-center mb-4">
                <div class="card-header" style="background-color: #1E3A57; color: white;">
                    <h6 class="my-0">BILANGAN MANGSA BANJIR DI PPS</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <h5 class="card-title mb-0 font-weight-bold">${data.total_records} ORANG</h5>
                </div>
            </div>
        `;
        cardsContainer.appendChild(card);

        cardsContainer.style.display = 'flex'; // Show the cards container
    })
    .catch(error => console.error('Error fetching record count:', error));
}

function fetchTotalRecordCardFam(selectedCity) {
    const cardsContainer2 = document.getElementById('cardsContainer2');

    // Make AJAX request to fetch total record count for distinct family_id values
    fetch(`fetch_data.php?pps_id=${selectedCity}&family_count=true`, { // Construct the URL with the query string
        method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error fetching record count:', data.error);
            return;
        }

        // Clear previous cards before appending new ones
        cardsContainer2.innerHTML = '';

        const card = document.createElement('div');
        card.className = 'd-flex justify-content-center align-items-center'; // Add Bootstrap flex utility classes
        card.style.height = '100%'; // Ensure the card takes the full height of the column
        card.innerHTML = `
            <div class="small-box" style="background-color: #DBECF4;" " text-center mb-4">
                <div class="card-header" style="background-color: #1E3A57; color: white;">
                    <h6 class="my-0">BILANGAN KELUARGA DI PPS</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <h5 class="card-title mb-0 font-weight-bold">${data.total_records_fam ? data.total_records_fam + ' ORANG' : 'No data available'}</h5>
                </div>
            </div>
        `;
        cardsContainer2.appendChild(card);

        cardsContainer2.style.display = 'flex'; // Show the cards container
    })
    .catch(error => console.error('Error fetching record count:', error));
}


function fetchStatistics(selectedCity) {
    const cardsContainer3 = document.getElementById('cardsContainer3');

    // Make AJAX request to fetch total record count for distinct family_id values
    fetch(`fetch_data.php?pps_id=${selectedCity}&percentage_capacity=true`, { // Construct the URL with the query string
        method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error fetching record count:', data.error);
            return;
        }

        // Clear previous cards before appending new ones
        cardsContainer3.innerHTML = '';

        const card = document.createElement('div');
        card.innerHTML = `
            <div class="small-box" style="background-color: #DBECF4;" " text-center mb-4">
                <div class="card-header" style="background-color: #1E3A57; color: white;">
                    <h6 class="my-0">    PERATUS KAPASITI MANGSA BANJIR</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <h5 class="card-title mb-0 font-weight-bold">${data.percentage_capacity ? data.percentage_capacity + ' %' : 'No data available'}</h5>
                </div>
            </div>
        `;
        cardsContainer3.appendChild(card);

        cardsContainer3.style.display = 'flex'; // Show the cards container
    })
    .catch(error => console.error('Error fetching record count:', error));
}

        
         $('#btnLogout').click(function (e) {
        e.preventDefault();
        
        // Show confirmation dialog
        Swal.fire({
            title: 'Adakah anda pasti untuk log keluar?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Log Keluar!',
            cancelButtonText: 'Batal',
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: 'logout.php',
                    type: 'POST',
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            // If logout is successful, show toast
                            Swal.fire({
                                icon: 'success',
                                title: 'Anda telah berjaya log keluar!',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 2000 // 3 seconds
                            }).then((result) => {
                                // Redirect to index.html after toast is closed
                                if (result.dismiss === Swal.DismissReason.timer) {
                                    window.location.href = 'index.html';
                                }
                            });
                        } else {
                            alert('Logout failed. Please try again.');
                        }
                    },
                    error: function () {
                        alert('An error occurred while trying to log out.');
                    }
                });
            }
        });
    });
        
    


    </script>


  <!-- Template Main JS File -->
  <script src="main.js"></script>

<!-- jQuery -->
<script src="jquery.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<script src="Chart.min.js"></script>
<!-- Sparkline -->

<!-- JQVMap -->
<script src="jquery.vmap.min.js"></script>
<script src="jquery.vmap.usa.js"></script>
<!-- jQuery Knob Chart -->
<script src="jquery.knob.min.js"></script>
<!-- daterangepicker -->
<script src="moment.min.js"></script>
<script src="daterangepicker.js"></script>
<!-- overlayScrollbars -->
<script src="jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="adminlte.js"></script>
<script src="dashboard.js"></script>
    </div>
    </div>
    </body>
</html>
